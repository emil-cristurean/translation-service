name: Create Docker Image

on:
  workflow_dispatch:
    inputs:
      versionIncrease:
        type: choice
        description: Select a version increase
        options:
          - patch
          - minor
          - major

jobs:
  create-docker-image:
    runs-on: [ cawe-linux-x64-general-small ]
    steps:
      - name: Setup java and gradle
        uses: rolls-royce/whispers-translation-service/.github/actions/setup-java-and-gradle@main

      - name: Update version
        run: ./gradlew --no-daemon clean reckonTagPush -Preckon.scope=${{ inputs.versionIncrease }} -Preckon.stage=final -x Test -DdmArtifactoryUser=${{ secrets.ODM_ARTIFACTORY_USER }} -DodmArtifactoryPassword=${{ secrets.ODM_ARTIFACTORY_PASSWORD }}

      - name: Get Latest Tag
        id: latest-tag
        run: |
          echo "LATEST_TAG=$(git describe --tags `git rev-list --tags --max-count=1`)" >> $GITHUB_OUTPUT
          echo "LATEST_TAG=$(git describe --tags `git rev-list --tags --max-count=1`)"

      - name: Print Latest Tag
        run: |
          echo ${{ steps.latest-tag.outputs.LATEST_TAG }}

      - name: Add build parameters
        run: printf "\nodmArtifactoryUser=${{ secrets.ODM_ARTIFACTORY_USER }}\nodmArtifactoryPassword=${{ secrets.ODM_ARTIFACTORY_PASSWORD }}\n" >> gradle.properties

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build service docker image
        uses: docker/build-push-action@v5
        with:
          context: ./
          push: false
          tags: whsprslocationservice:${{ steps.latest-tag.outputs.LATEST_TAG }}
          cache-from: type=gha,mode=max
          cache-to: type=gha,mode=max
          build-args: |
            ODM_ARTIFACTORY_USER=${{ secrets.ODM_ARTIFACTORY_USER }}
            ODM_ARTIFACTORY_PASSWORD=${{ secrets.ODM_ARTIFACTORY_PASSWORD }}
            GIT_LAST_COMMIT_SHA=${{ github.sha }}
